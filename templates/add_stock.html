{% extends 'base.html' %}

{% block content %}
<div class="content">

    <!-- Flex 容器 -->
    <div class="flex-container">

        <!-- 入库表单 -->
        <div class="form-section flex-item">
            <h3>入库</h3>
            <form method="post">
                <input type="hidden" name="form_type" value="in">
                <label for="item_id_in">物品:</label>
                <select name="item_id" id="item_id_in" class="select2-item" required>
                    <option value="">请选择物品</option>
                    {% for item in all_items %}
                        <option value="{{ item.id }}">{{ item.item_name }} {{ item.item_spec }}</option>
                    {% endfor %}
                </select><br>
                <label for="inbound_qty">入库数量:</label>
                <input type="number" name="inbound_qty" id="inbound_qty" required><br>
                <label for="inbound_date">入库日期:</label>
                <input type="date" name="inbound_date" id="inbound_date" required><br>
                <label for="warehouse_number_in">仓库号:</label>
                <input type="number" name="warehouse_number" id="warehouse_number_in" required><br>
                <label for="shelf_number_in">货架号:</label>
                <input type="number" name="shelf_number" id="shelf_number_in" required><br>
                <label for="layer_number_in">层数:</label>
                <input type="number" name="layer_number" id="layer_number_in" required><br>
                <label for="sn_code_in">SN码:</label>
                <input type="text" name="sn_code" id="sn_code_in"><br>  <!-- 添加 SN 码输入框 -->
                <button type="submit">提交入库</button>
            </form>
        </div>

        <!-- 出库表单 -->
        <div class="form-section flex-item">
            <h3>出库</h3>
            <form method="post">
                <input type="hidden" name="form_type" value="out">
                <label for="item_id_out">物品:</label>
                <select name="item_id" id="item_id_out" class="select2-item" required onchange="loadLocations(); loadSNs()">  <!-- 修改 onchange 事件 -->
                    <option value="">请选择物品</option>
                    {% for item in stocked_items %}
                        <option value="{{ item.id }}">{{ item.item_name }} {{ item.item_spec }}</option>
                    {% endfor %}
                </select><br>
                <label for="outbound_qty">出库数量:</label>
                <input type="number" name="outbound_qty" id="outbound_qty" required><br>
                <label for="outbound_date">出库日期:</label>
                <input type="date" name="outbound_date" id="outbound_date" required><br>
                <label for="outbound_person">出库人员:</label>
                <input type="text" name="outbound_person" id="outbound_person" required><br>
                <label for="outbound_purpose">出库用途:</label>
                <input type="text" name="outbound_purpose" id="outbound_purpose" required><br>
                <label for="location_id_out">出库位置:</label>
                <div id="location_options">
                    <select name="location_id" id="location_id_out" required>
                        <option value="">请选择位置</option>
                        {% for location in locations %}
                            <option value="{{ location.id }}">
                                {{ location.warehouse_number }}号仓库
                                {{ location.shelf_number }}号货架
                                {{ location.layer_number }}层
                            </option>
                    {% endfor %}
                </select><br>
                </div>
                <label for="sn_code_out">SN码:</label>
                <select name="sn_code" id="sn_code_out" class="select2-sn">  <!-- 添加 SN 码下拉列表 -->
                    <option value="">请选择SN码</option>
                </select><br>
                <button type="submit">提交出库</button>
            </form>
        </div>

    </div>
</div>

<script>
$(document).ready(function() {
    $('.select2-item').select2();
    $('.select2-sn').select2(); // 初始化 SN 码下拉列表

    // 阻止入库 SN 码输入框回车提交表单
    document.getElementById('sn_code_in').addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
        }
    });
});

function loadLocations() {
    var item_id = document.getElementById('item_id_out').value;
    if (item_id) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/get_locations?item_id=' + item_id, true);
        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                var locations = JSON.parse(xhr.responseText);
                var locationSelect = document.getElementById('location_id_out');
                locationSelect.innerHTML = '<option value="">请选择位置</option>';
                for (var i = 0; i < locations.length; i++) {
                    var location = locations[i];
                    var option = document.createElement('option');
                    option.value = location.id;
                    option.text = location.warehouse_number + '号仓库' + location.shelf_number + '号货架' + location.layer_number + '层';
                    locationSelect.appendChild(option);
                }
            } else {
                console.error('Request failed with status: ' + xhr.status);
            }
        };
        xhr.onerror = function() {
            console.error('Request failed');
        };
        xhr.send();
    }
}

function loadSNs() { // 加载 SN 码的函数
    var item_id = document.getElementById('item_id_out').value;
    if (item_id) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/get_sns?item_id=' + item_id, true); // 新的 URL
        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                var sns = JSON.parse(xhr.responseText);
                var snSelect = document.getElementById('sn_code_out');
                snSelect.innerHTML = '<option value="">请选择SN码</option>';
                for (var i = 0; i < sns.length; i++) {
                    var sn = sns[i];
                    var option = document.createElement('option');
                    option.value = sn;
                    option.text = sn;
                    snSelect.appendChild(option);
                }
                $('.select2-sn').select2(); // 重新初始化 select2，确保更新后的选项也能搜索
            } else {
                console.error('Request failed with status: ' + xhr.status);
            }
        };
        xhr.onerror = function() {
            console.error('Request failed');
        };
        xhr.send();
    }
}
</script>

<style>
    /* 响应式布局核心代码 */
    .flex-container {
        display: flex;
        flex-direction: column;  /* 移动端默认垂直排列 */
        gap: 20px;              /* 元素间距 */
    }

    .flex-item {
        width: 100%;            /* 移动端占满宽度 */
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
        box-sizing: border-box; /* 防止padding影响宽度 */
    }

    /* 电脑端布局（768px以上） */
    @media (min-width: 768px) {
        .flex-container {
            flex-direction: row;   /* 横向排列 */
            justify-content: space-between;
        }

        .flex-item {
            width: calc(50% - 10px); /* 考虑间隙的精确计算 */
        }
    }

    /* 移动端优化 */
    @media (max-width: 480px) {
        input, select, button {
            width: 100%;         /* 表单元素占满宽度 */
            margin-bottom: 8px;  /* 增加移动端操作间距 */
        }
    }
</style>
{% endblock %}
