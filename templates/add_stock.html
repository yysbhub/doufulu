{% extends 'base.html' %}

{% block content %}
<div class="content">

    <!-- Flex 容器 -->
    <div class="flex-container">

        <!-- 入库表单 -->
        <div class="form-section flex-item">
            <h3>入库</h3>
            <form method="post" onsubmit="return handleFormSubmit()">
                <input type="hidden" name="form_type" value="in">
                <label for="item_id_in">物品:</label>
                <select name="item_id" id="item_id_in" class="select2-item" required>
                    <option value="">请选择物品</option>
                    {% for item in all_items %}
                        <option value="{{ item.id }}">{{ item.item_name }} {{ item.item_spec }}</option>
                    {% endfor %}
                </select><br>
                <label for="inbound_qty">入库数量:</label>
                <input type="number" name="inbound_qty" id="inbound_qty" required><br>  <!-- 初始状态可编辑 -->
                <label for="inbound_date">入库日期:</label>
                <input type="date" name="inbound_date" id="inbound_date" required><br>
                <label for="warehouse_number_in">仓库号:</label>
                <input type="number" name="warehouse_number" id="warehouse_number_in" required><br>
                <label for="shelf_number_in">货架号:</label>
                <input type="number" name="shelf_number" id="shelf_number_in" required><br>
                <label for="layer_number_in">层数:</label>
                <input type="number" name="layer_number" id="layer_number_in" required><br>
                <label for="sn_code_in">SN码:</label>
                <input type="text" id="sn_code_in"><br>  <!-- 移除 name 属性 和 required 属性-->
                <div id="sn_code_list"></div>  <!-- 用于显示 SN 码悬浮框 -->
                <input type="hidden" name="sn_codes" id="sn_codes">  <!-- 用于存储 SN 码 -->
                <button type="submit">提交入库</button>
            </form>
        </div>

        <!-- 出库表单 -->
        <div class="form-section flex-item">
            <h3>出库</h3>
            <form method="post">
                <input type="hidden" name="form_type" value="out">
                <label for="item_id_out">物品:</label>
                <select name="item_id" id="item_id_out" class="select2-item" required onchange="loadLocations(); loadSNs()">  <!-- 修改 onchange 事件 -->
                    <option value="">请选择物品</option>
                    {% for item in stocked_items %}
                        <option value="{{ item.id }}">{{ item.item_name }} {{ item.item_spec }}</option>
                    {% endfor %}
                </select><br>
                <label for="outbound_qty">出库数量:</label>
                <input type="number" name="outbound_qty" id="outbound_qty" required><br>
                <label for="outbound_date">出库日期:</label>
                <input type="date" name="outbound_date" id="outbound_date" required><br>
                <label for="outbound_person">出库人员:</label>
                <input type="text" name="outbound_person" id="outbound_person" required><br>
                <label for="outbound_purpose">出库用途:</label>
                <input type="text" name="outbound_purpose" id="outbound_purpose" required><br>
                <label for="location_id_out">出库位置:</label>
                <div id="location_options">
                    <select name="location_id" id="location_id_out" required>
                        <option value="">请选择位置</option>
                        {% for location in locations %}
                            <option value="{{ location.id }}">
                                {{ location.warehouse_number }}号仓库
                                {{ location.shelf_number }}号货架
                                {{ location.layer_number }}层
                            </option>
                    {% endfor %}
                </select><br>
                </div>
                <label for="sn_code_out">SN码:</label>
                <select name="sn_code" id="sn_code_out" class="select2-sn">  <!-- 添加 SN 码下拉列表 -->
                    <option value="">请选择SN码</option>
                </select><br>
                <button type="submit">提交出库</button>
            </form>
        </div>

    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    $('.select2-item').select2();
    $('.select2-sn').select2(); // 初始化 SN 码下拉列表

    var snCodes = [];  // 用于存储 SN 码
    var inboundQtyInput = document.getElementById('inbound_qty');
    var itemIdInput = document.getElementById('item_id_in');
    var snCodeInput = document.getElementById('sn_code_in');

    // 入库 SN 码输入框回车事件
    document.getElementById('sn_code_in').addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // 阻止默认行为
            var snCode = this.value.trim(); // 获取 SN 码并去除空格
            if (snCode !== '') {
                // 检查 SN 码是否已存在
                checkDuplicateSnCode(snCode);
            }
        }
    });

    // 检查 SN 码是否已存在
    function checkDuplicateSnCode(snCode) {
        var itemId = itemIdInput.value; // 获取物品 ID

        // 过滤掉 "已损毁" 的 SN 码
        if (snCode === '已损毁') {
            addSnCode(snCode); // 直接添加 "已损毁" 的 SN 码
            return;
        }

        // 使用 AJAX 检查重复 SN 码
        $.ajax({
            url: '/check_duplicate_sn',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                item_id: itemId,
                sn_code: snCode
            }),
            success: function(response) {
                if (response.is_duplicate) {
                    alert('SN 码 ' + snCode + ' 已存在于库存中，请检查！');
                } else {
                    addSnCode(snCode); // 添加 SN 码
                }
            }
        });
    }

    // 添加 SN 码到列表
    function addSnCode(snCode) {
        if (!snCodes.includes(snCode)) { // 检查是否已存在
            snCodes.push(snCode); // 添加到数组
            updateSnCodeList(); // 更新 SN 码列表
            document.getElementById('sn_code_in').value = ''; // 清空输入框
            // 禁用入库数量输入框
            inboundQtyInput.readOnly = true;
            updateInboundQty(); // 更新入库数量
        } else {
            alert('SN码已存在于当前列表中！');
        }
    }

    // 删除 SN 码
    function deleteSnCode(snCode) {
        snCodes = snCodes.filter(function(item) {
            return item !== snCode;
        });
        updateSnCodeList(); // 更新 SN 码列表
        updateInboundQty(); // 更新入库数量

        // 如果 SN 码列表为空，则允许手动输入入库数量
        if (snCodes.length === 0) {
            inboundQtyInput.readOnly = false;
        }
    }

    // 更新 SN 码列表
    function updateSnCodeList() {
        var snCodeList = document.getElementById('sn_code_list');
        snCodeList.innerHTML = ''; // 清空列表

        snCodes.forEach(function(snCode) {
            var snCodeItem = document.createElement('div');
            snCodeItem.classList.add('sn-code-item');
            snCodeItem.textContent = snCode;

            var deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-button');
            deleteButton.textContent = 'x';
            deleteButton.onclick = function() {
                deleteSnCode(snCode);
            };

            snCodeItem.appendChild(deleteButton);
            snCodeList.appendChild(snCodeItem);
        });

        // 将 SN 码数组存储到隐藏输入框中
        document.getElementById('sn_codes').value = JSON.stringify(snCodes);
    }

    // 更新入库数量
    function updateInboundQty() {
        if (snCodes.length === 0) {
            // 如果没有 SN 码，则不更新入库数量
            return;
        }
        document.getElementById('inbound_qty').value = snCodes.length;
    }

    // 提交表单前更新隐藏输入框
    document.querySelector('form').addEventListener('submit', function() {
        document.getElementById('sn_codes').value = JSON.stringify(snCodes);
    });
});

function loadLocations() {
    var item_id = document.getElementById('item_id_out').value;
    if (item_id) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/get_locations?item_id=' + item_id, true);
        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                var locations = JSON.parse(xhr.responseText);
                var locationSelect = document.getElementById('location_id_out');
                locationSelect.innerHTML = '<option value="">请选择位置</option>';
                for (var i = 0; i < locations.length; i++) {
                    var location = locations[i];
                    var option = document.createElement('option');
                    option.value = location.id;
                    option.text = location.warehouse_number + '号仓库' + location.shelf_number + '号货架' + location.layer_number + '层';
                    locationSelect.appendChild(option);
                }
            } else {
                console.error('Request failed with status: ' + xhr.status);
            }
        };
        xhr.onerror = function() {
            console.error('Request failed');
        };
        xhr.send();
    }
}

function loadSNs() { // 加载 SN 码的函数
    var item_id = document.getElementById('item_id_out').value;
    if (item_id) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/get_sns?item_id=' + item_id, true); // 新的 URL
        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                var sns = JSON.parse(xhr.responseText);
                var snSelect = document.getElementById('sn_code_out');
                snSelect.innerHTML = '<option value="">请选择SN码</option>';
                for (var i = 0; i < sns.length; i++) {
                    var sn = sns[i];
                    var option = document.createElement('option');
                    option.value = sn;
                    option.text = sn;
                    snSelect.appendChild(option);
                }
                $('.select2-sn').select2(); // 重新初始化 select2，确保更新后的选项也能搜索
            } else {
                console.error('Request failed with status: ' + xhr.status);
            }
        };
        xhr.onerror = function() {
            console.error('Request failed');
        };
        xhr.send();
    }
}

function handleFormSubmit() {
    return true; // 允许表单正常提交
}
</script>

<style>
    /* 响应式布局核心代码 */
    .flex-container {
        display: flex;
        flex-direction: column;  /* 移动端默认垂直排列 */
        gap: 20px;              /* 元素间距 */
    }

    .flex-item {
        width: 100%;            /* 移动端占满宽度 */
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
        box-sizing: border-box; /* 防止padding影响宽度 */
    }

    /* 电脑端布局（768px以上） */
    @media (min-width: 768px) {
        .flex-container {
            flex-direction: row;   /* 横向排列 */
            justify-content: space-between;
        }

        .flex-item {
            width: calc(50% - 10px); /* 考虑间隙的精确计算 */
        }
    }

    /* 移动端优化 */
    @media (max-width: 480px) {
        input, select, button {
            width: 100%;         /* 表单元素占满宽度 */
            margin-bottom: 8px;  /* 增加移动端操作间距 */
        }
    }

    /* SN 码悬浮框样式 */
    .sn-code-item {
        display: inline-block;
        padding: 5px 10px;
        margin: 5px;
        background-color: #eee;
        border-radius: 5px;
        position: relative;
    }

    /* 删除按钮样式 */
    .sn-code-item .delete-button {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #f00;
        color: #fff;
        border: none;
        cursor: pointer;
    }
</style>
{% endblock %}
